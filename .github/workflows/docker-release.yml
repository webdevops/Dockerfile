name: Docker build & push (GHCR + Docker Hub)

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - "v*"
      - "release-*"
  workflow_dispatch:

env:
  PLATFORMS: linux/amd64,linux/arm64

jobs:
  build-and-push:
    name: Build & Push (all ./docker/**/Dockerfile)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write  # nötig für GHCR (ghcr.io) via GITHUB_TOKEN

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Provisioning (generiert Dateien in ./docker aus Templates) ---
      # Siehe README des Repos; falls bei dir nicht nötig, Schritt einfach auskommentieren.
      - name: Provision docker/ from templates
        run: |
          docker run --rm -v "$PWD:/app" -w /app webdevops/dockerfile-build-env make provision
        # Quelle: README beschreibt den Provisioning-Schritt.

      - name: Lowercase owner + registry prefixes
        run: |
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV
          echo "GHCR_PREFIX=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV
          echo "DH_PREFIX=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- Alle Dockerfiles unter ./docker/**/Dockerfile einsammeln ---
      - name: Generate build matrix from ./docker
        id: mx
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t files < <(find ./docker -type f -name Dockerfile | sort)
          if [ ${#files[@]} -eq 0 ]; then
            echo "Keine Dockerfiles unter ./docker gefunden"; exit 1
          fi
          json='{"include":['
          first=1
          for f in "${files[@]}"; do
            dir=$(dirname "$f")
            rel="${dir#./docker/}"             # z.B. php-nginx/8.3
            IFS='/' read -r -a parts <<< "$rel"
            component="${parts[0]}"            # z.B. php-nginx
            tag="${parts[${#parts[@]}-1]}"     # z.B. 8.3
            [ $first -eq 1 ] || json+=","
            first=0
            json+="{\"context\":\"$dir\",\"component\":\"$component\",\"tag\":\"$tag\"}"
          done
          json+=']}'
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

      # --- Matrix-Build pro Image/Tag ---
      - name: Build & Push (multi-arch) per image
        uses: docker/bake-action@v5
        with:
          push: true
          set: |
            *.cache-from=type=gha
            *.cache-to=type=gha,mode=max
        env:
          # Übergabe der Matrix als Bake-Definition:
          # Wir erzeugen dynamisch Bake targets per shell und rufen bake erneut auf.
          # (Workaround: bake-action kann auch inline HCL bekommen; hier per preparatory step)
          DUMMY: yes

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(steps.mx.outputs.matrix) }}

  # Pro-Matrix-Job: Build jeweils ein Image
  per-image:
    name: Build & Push ${{ matrix.component }}:${{ matrix.tag }}
    runs-on: ubuntu-latest
    needs: build-and-push

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare names & tags
        id: prep
        run: |
          echo "IMAGE_GHCR=${{ env.GHCR_PREFIX }}/${{ matrix.component }}" >> $GITHUB_ENV
          echo "IMAGE_DH=${{ env.DH_PREFIX }}/${{ matrix.component }}" >> $GITHUB_ENV
          echo "TAG=${{ matrix.tag }}" >> $GITHUB_ENV

      - name: Docker metadata (GHCR + Docker Hub)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.IMAGE_GHCR }}
            ${{ env.IMAGE_DH }}
          tags: |
            type=raw,value=${{ env.TAG }}
            # Zusätzlich bei Tag-Pushes/Branches semantische/Ref-Tags hinzufügen:
            type=ref,event=tag
            type=ref,event=branch
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build & Push ${{ matrix.component }}:${{ env.TAG }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
